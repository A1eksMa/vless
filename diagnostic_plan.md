# План диагностики после миграции сервера X-ray

Этот документ описывает шаги для проверки состояния системы после выполнения миграции согласно `migration.md`.

## 1. Проверка Docker-контейнера

-   **Цель:** Убедиться, что контейнер `3x-ui` запущен и работает без ошибок.
-   **Команда:**
    ```bash
    docker ps -f name=3x-ui
    docker logs 3x-ui
    ```
-   **Ожидаемый результат:**
    -   Команда `docker ps` должна показать, что контейнер `3x-ui` находится в состоянии `Up`.
    -   Логи `docker logs` не должны содержать критических ошибок (например, "code: 23" или "privateKey is empty"). В логах должно быть упоминание о прослушивании портов, в частности `43443` для X-ray.

## 2. Проверка сетевых портов

-   **Цель:** Убедиться, что правильные службы прослушивают правильные порты.
-   **Команда:**
    ```bash
    ss -tlpn
    ```
-   **Ожидаемый результат:**
    -   Процесс `apache2` должен прослушивать порт `443`.
    -   Процесс `xray-linux-amd64` (или главный процесс контейнера) должен прослушивать порт `43443`.
    -   Процесс `x-ui` (внутри контейнера) должен прослушивать порт `2053`.
    -   Порт `8443` **не должен** быть в списке прослушиваемых.

## 3. Проверка конфигурации брандмауэра (UFW)

-   **Цель:** Убедиться, что правила брандмауэра соответствуют новой архитектуре.
-   **Команда:**
    ```bash
    ufw status numbered
    ```
-   **Ожидаемый результат:**
    -   Должно быть правило `ALLOW IN` для порта `443/tcp`.
    -   Должно быть правило `ALLOW IN` для порта `43443/tcp`.
    -   Правила для порта `8443` быть **не должно**.

## 4. Проверка доступности веб-панели

-   **Цель:** Проверить, что панель управления доступна извне через Apache на порту 443.
-   **Команда:**
    ```bash
    curl -s -o /dev/null -w "%{http_code}" https://pgserver.online/xray/ --insecure
    ```
    *Используем `--insecure`, так как `curl` на сервере может не доверять сертификату Let's Encrypt без дополнительных настроек.*
-   **Ожидаемый результат:**
    -   Команда должна вернуть HTTP-код `200`. Это будет означать, что Apache работает и успешно проксирует запрос к панели `3x-ui`.

## 5. Проверка доступности сервиса X-ray (VLESS)

-   **Цель:** Проверить, что порт `43443` открыт и доступен извне.
-   **Команда:**
    ```bash
    apt-get update && apt-get install -y nmap
    nmap -p 43443 localhost
    ```
-   **Ожидаемый результат:**
    -   `nmap` должен показать, что порт `43443` находится в состоянии `OPEN`.
