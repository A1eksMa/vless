# Документация по управлению и настройке сервера XRay

Этот документ описывает архитектуру и процедуры управления для сервера XRay, работающего в Docker-контейнере с веб-интерфейсом `3x-ui`.

## 1. Обзор архитектуры

Система состоит из нескольких ключевых компонентов, работающих вместе для обеспечения безопасного прокси-сервиса и удобного управления.

### Архитектурная схема (текстовая)

```
      ИНТЕРНЕТ
          |
          |---------------------------------------------------|
          |                                                   |
 (Порт 443 - VLESS)                                (Порт 8443 - HTTPS)
          |                                                   |
+---------|---------------------------------------------------|---------+
|         |                                                   |         |
|  +------V------+                                     +------V------+  |
|  |             |                                     |             |  |
|  |   XRay-сервер |                                     |   Apache2   |  |
|  |  (в Docker) |                                     | (Хост-система) |  |
|  |             |                                     |             |  |
|  +-------------+                                     +------|------+  |
|         ^                                                    |         |
|         | (Генерация config.json)                            | (Прокси на localhost:2053)
|         |                                                    |         |
|  +------|------+                                     +------V------+  |
|  |             |                                     |             |  |
|  |  3x-ui Панель |<------------------------------------| Администратор |  |
|  |  (в Docker) |                                     |             |  |
|  | (Порт 2053) |                                     +-------------+  |
|  +-------------+                                                      |
|                                                                       |
|                                   Docker-контейнер ("host" сеть)      |
+-----------------------------------------------------------------------+
```

### Описание взаимодействия

1.  **Клиенты XRay** подключаются напрямую к серверу XRay на **порту 443**, используя протокол VLESS. Этот трафик обрабатывается процессом XRay внутри Docker-контейнера.
2.  **Сетевой администратор** получает доступ к панели управления `3x-ui` через веб-браузер, заходя на `https://<имя_сервера>:8443/xray/`.
3.  **Apache2**, работающий на хост-системе, прослушивает порт **8443** и действует как обратный прокси. Он перенаправляет запросы администратор�� на внутренний порт `2053`, где работает веб-интерфейс `3x-ui`.
4.  **Панель `3x-ui`** при запуске и при внесении изменений через веб-интерфейс генерирует файл конфигурации для XRay (`config.json`).
5.  **Брандмауэр UFW** контролирует весь внешний доступ. Он разрешает трафик на порты `443` (XRay) и `8443` (Apache), но **блокирует** прямой доступ к панели `3x-ui` (порт `2053`), обеспечивая дополнительный уровень безопасности.

---

## 2. Компоненты

### 2.1. Docker-контейнер `3x-ui`

*   **Образ:** `ghcr.io/mhsanaei/3x-ui:latest`
*   **Имя:** `3x-ui`
*   **Сетевой режим:** `host`. Это означает, что контейнер использует сетевой интерфейс хоста напрямую, без изоляции сети Docker. Любой порт, открытый в контейнере, открыт на хосте.
*   **Пос��оянное хранилище:** Данные панели (включая базу данных конфигурации) хранятся на хосте в директории `/root/3x-ui/db`, которая монтируется в контейнер по пути `/etc/x-ui`. Это гарантирует, что пользователи и настройки сохраняются при перезапуске или обновлении контейнера.
*   **Политика перезапуска:** `unless-stopped`. Контейнер автоматически перезапустится, если он выйдет из строя, но не будет запущен, если был остановлен вручную.

### 2.2. Сервер XRay

*   **Процесс:** `xray-linux-amd64` запускается внутри контейнера `3x-ui`.
*   **Конфигурация:** Управляется **исключительно** через веб-интерфейс `3x-ui`. Панель динамически генерирует файл `/app/bin/config.json` на основе настроек, хранящихся в ее ��азе данных.
    *   **Важно:** Прямое редактирование `config.json` внутри контейнера **не будет иметь эффекта**, так как файл будет перезаписан при следующем запуске или изменении настроек в панели.
*   **Протокол:** Используется VLESS на порту `443`.

### 2.3. Панель управления 3x-ui

*   **Доступ:** `https://<имя_сервера>:8443/xray/`
*   **Процесс:** `x-ui` запускается внутри контейнера и слушает порт `2053`.
*   **База данных:** Используется база данных SQLite, расположенная по пути `/etc/x-ui/x-ui.db` внутри контейнера (и, соответственно, в `/root/3x-ui/db/x-ui.db` на хосте). В этой базе хранятся все настройки, включая информацию о пользователях, входящих подключениях и параметрах XRay.

### 2.4. Обратный прокс�� Apache2

*   **Назначение:** Обеспечивает безопасный доступ к панели управления `3x-ui` через HTTPS и скрывает реальный порт панели от Интернета.
*   **Конфигурация:** `/etc/apache2/sites-enabled/pgserver.online.conf`
*   **Ключевые директивы:**
    *   `Listen 8443`: Apache принимает HTTPS-соединения на порту `8443`.
    *   `ProxyPass /xray/ http://localhost:2053/`: Перенаправляет все запросы, начинающиеся с `/xray/`, на веб-сервер `3x-ui`.
    *   `RedirectMatch permanent ^/xray$ /xray/`: Автоматически добавляет завершающий слэш к URL, чтобы избежать проблем с относительными путями.

### 2.5. Брандмауэр UFW

*   **Статус:** `active`
*   **Политика по умолчанию:** Запрещать все входящие соединения (`deny (incoming)`).
*   **Ключевые правила:**
    *   `ALLOW IN 443`: Разрешает подкл��чения к XRay.
    *   `ALLOW IN 8443`: Разрешает подключения к веб-панели через Apache.
    *   `DENY IN 2053`: **Запрещает** прямой доступ к веб-панели из Интернета.

---

## 3. Управление учетными записями

### 3.1. Доступ к панели

1.  Откройте веб-браузер и перейдите по адресу: `https://<имя_сервера>:8443/xray/`
2.  Введите логин и пароль, установленные для панели `3x-ui`.

### 3.2. Создание нового пользователя

1.  В панели управления перейдите в раздел "Inbounds".
2.  Выберите существующее входящее подключение (например, VLESS на порту 443).
3.  Нажмите на кнопку "Add User" или аналогичную.
4.  Введите необходимую информацию (например, email или UUID).
5.  Сохраните изменения. Панель автоматически сгенерирует новую конфигурацию для XRay.

### 3.3. Получение конфигурации для клиента

После создания пользователя панель предоставит ссылку для импорта или QR-код, который можно использовать в клиентских приложениях (например, v2rayN, Nekoray, Streisand).

---

## 4. Важные выводы из отчета об инциденте

*   **Конфигурация XRay управляется базой данных:** Никогда не редактируйте `config.json` напрямую. Все изменения должны производиться через веб-интерфейс `3x-ui` или, в крайнем случае, путем прямого редактирования базы данных `x-ui.db` (требуется `sqlite3`).
*   **Код ошибки XRay 23:** Означает ошибку в файле конфигурации. Если XRay не запускается, в первую очередь следует проверить логи контейнера на наличие этой ошибки.
*   **REALITY требует `privateKey`:** При настройке входящих подключений с типом `reality` убедитесь, что поле `privateKey` заполнено. Пустое значение приведет к сбою запуска XRay.
