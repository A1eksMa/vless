# Инструкция: Управление XRay через базу данных x-ui.db

В этом руководстве описан процесс управления конфигурацией XRay путем прямого взаимодействия с базой данных SQLite (`x-ui.db`) из командной строки. Этот метод предназначен для опытных пользователей и для случаев, когда доступ к веб-интерфейсу невозможен или требуется автоматизация.

**Внимание:** Прямое редактирование базы данных может привести к повреждению конфигурации и полной остановке сервиса. Действуйте с максимальной осторожностью.

---

## 1. Безопасность и Резервное копирование

Перед любыми изменениями **обязательно** создайте резервную копию базы данных. Если что-то пойдет не так, вы сможете быстро восстановить рабочее состояние.

База данных находится по пути: `/root/3x-ui/db/x-ui.db`.

**Команда для создания бэкапа:**
```bash
# Создаем копию с текущей датой и временем
cp /root/3x-ui/db/x-ui.db /root/3x-ui/db/x-ui.db.bak_$(date +%Y-%m-%d_%H-%M-%S)
```

---

## 2. Анализ структуры базы данных

Для взаимодействия с базой используется утилита `sqlite3`.

### 2.1. Ключевые таблицы

В базе данных есть несколько таблиц, но для управления пользователями и подключениями ключевыми являются две:

1.  `inbounds`: Хранит настройки входящих подключений (протоколы, порты, параметры).
2.  `client_traffics`: Хранит данные кли��нтов (пользователей), привязанных к `inbounds`, их трафик и индивидуальные настройки.

### 2.2. Структура таблицы `inbounds`

Эта таблица определяет, какие порты и протоколы слушает XRay.

```sql
CREATE TABLE `inbounds` (
  `id` integer PRIMARY KEY AUTOINCREMENT, -- Уникальный идентификатор
  `user_id` integer,                      -- ID пользователя-владельца (из таблицы users)
  `up` integer,                           -- Общий трафик вверх (байт)
  `down` integer,                         -- Общий трафик вниз (байт)
  `total` integer,                        -- Общий лимит трафика (байт)
  `remark` text,                          -- Название/описание подключения
  `enable` numeric,                       -- Статус (1 - включено, 0 - выключено)
  `expiry_time` integer,                  -- Срок действия (timestamp)
  `listen` text,                          -- IP-адрес для прослушивания (пусто = все)
  `port` integer,                         -- Порт прослушивания
  `protocol` text,                        -- Протокол (vless, vmess, etc.)
  `settings` text,                        -- JSON-строка с основными настройками протокола
  `stream_settings` text,                 -- JSON-строка с настройками транспорта (tcp, ws, reality)
  `tag` text,                             -- Внутренний тег для маршрутизации
  `sniffing` text                         -- JSON-строка с настройками `sniffing`
);
```

### 2.3. Структура таблицы `client_traffics`

Эта таблица содержит список клиентов (пользователей), которые привязаны к определенному `inbound`.

```sql
CREATE TABLE `client_traffics` (
  `id` integer PRIMARY KEY AUTOINCREMENT, -- Уникальный ID клиента
  `inbound_id` integer,                   -- ID подключения из таблицы `inbounds`
  `enable` numeric,                       -- Статус клиента (1 - включен, 0 - выключен)
  `email` text,                           -- Уникальное имя/идентификатор клиента
  `up` integer,                           -- Трафик клиента вверх (байт)
  `down` integer,                         -- Трафик клиента вниз (байт)
  `expiry_time` integer,                  -- Персональный срок действия (timestamp)
  `total` integer,                        -- Персональный лимит трафика (байт)
  CONSTRAINT `fk_inbounds_client_stats` FOREIGN KEY (`inbound_id`) REFERENCES `inbounds`(`id`)
);
```
**Ключевая связь:** Поле `inbound_id` в таблице `client_traffics` указывает, к какому именно подключению из таблицы `inbounds` относится данный клиент.

---

## 3. Получение информации из БД (Списки)

Для выполнения запросов из командной строки используется команда `sqlite3 /путь/к/базе "SQL-запрос"`.

### 3.1. Список входящих подключений (`inbounds`)

```bash
sqlite3 /root/3x-ui/db/x-ui.db "SELECT id, protocol, port, remark, enable FROM inbounds;"
```
*Пример вывода:*
```
1|vless|43443|VLESS-Reality|1
```

### 3.2. Список пользователей (`client_traffics`)

Для более наглядного вывода можно объединить данные из двух таблиц, чтобы видеть, к какому подключению относится каждый пользователь.

```bash
sqlite3 /root/3x-ui/db/x-ui.db "SELECT c.id, c.email, c.enable, i.remark as inbound_remark FROM client_traffics c JOIN inbounds i ON c.inbound_id = i.id;"
```
*Пример вывода:*
```
1|VLESS-Reality-a1ex_ma|1|VLESS-Reality
2|VLESS-TCP-user2|1|VLESS-TCP
```

---

## 4. Изменение конфигурации (Пример)

**Задача:** Для пользователя `VLESS-Reality-a1ex_ma` изменить порт подключения с `443` на `43443`.

**Логика:** Порт явля��тся свойством **входящего подключения (`inbound`)**, а не конкретного пользователя. Поэтому нам нужно:
1.  Найти, к какому `inbound` относится пользователь `VLESS-Reality-a1ex_ma`.
2.  Изменить порт у этого `inbound`. Это изменение затронет **всех** пользователей, привязанных к данному `inbound`.

### Шаг 1: Найти `inbound_id` для пользователя

```bash
# Запоминаем ID в переменную для удобства
INBOUND_ID=$(sqlite3 /root/3x-ui/db/x-ui.db "SELECT inbound_id FROM client_traffics WHERE email = 'VLESS-Reality-a1ex_ma';")

# Проверяем, что ID найден
echo "Найден Inbound ID: $INBOUND_ID"
```

### Шаг 2: Изменить порт для найденного `inbound`

Используем полученный `$INBOUND_ID` для обновления нужной записи в таблице `inbounds`.

```bash
# Выполняем SQL-запрос на обновление
sqlite3 /root/3x-ui/db/x-ui.db "UPDATE inbounds SET port = 43443 WHERE id = ${INBOUND_ID};"

# Проверяем результат
echo "Новая конфигурация для inbound $INBOUND_ID:"
sqlite3 /root/3x-ui/db/x-ui.db "SELECT id, protocol, port, remark FROM inbounds WHERE id = ${INBOUND_ID};"
```
*Пример вывода после проверки:*
```
Новая конфигурация для inbound 1:
1|vless|43443|VLESS-Reality
```

---

## 5. Применение изменений

После внесения изменений в базу данных, процесс XRay, запущенный в контейнере, **не узнает** о них автоматически. Панель `3x-ui` читает базу и генерирует `config.json` для XRay только при своем запуске.

Чтобы изменения вступили в силу, необходимо перезапустить Docker-контейнер.

**Команда для перезапуска контейнера:**
```bash
docker restart 3x-ui
```

После выполнения этой команды контейнер перезапустится, `3x-ui` сгенерирует новый `config.json` на основе обновленных данных из базы, и XRay запустится с новой конфигурацией.
