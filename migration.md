# План миграции сервера X-ray и Apache2

**Дата:** 29 ноября 2025

## 1. Цель миграции

Перенастроить сетевую конфигурацию сервера для использования стандартного HTTPS-порта (443) для веб-панели управления, что позволит автоматизировать получение и обновление SSL-сертификатов через Certbot (Let's Encrypt). Сервис X-ray (VLESS) будет перенесен на нестандартный порт.

---

### Текущая конфигурация (до миграции)

*   **Apache2 (панель):** `8443/tcp` (HTTPS, самоподписанный сертификат)
*   **X-ray (VLESS):** `443/tcp`
*   **UFW:** Разрешены порты `443`, `8443`.

### Целевая конфигурация (после миграции)

*   **Apache2 (панель):** `443/tcp` (HTTPS, сер��ификат Let's Encrypt)
*   **X-ray (VLESS):** `43443/tcp`
*   **UFW:** Разрешены порты `443`, `43443`. Порт `8443` будет закрыт.

---

## 2. ВАЖНО: Меры предосторожности

Перед началом работ **обязательно** создайте резервные копии ключевых файлов конфигурации. В случае сбоя это позволит быстро восстановить работоспособность системы.

```bash
# Создаем директорию для бэкапов
mkdir -p /root/migration_backup

# 1. Бэкап конфигурации Apache
cp /etc/apache2/sites-enabled/pgserver.online.conf /root/migration_backup/pgserver.online.conf.bak

# 2. Бэкап базы данных 3x-ui (самый важный шаг)
cp /root/3x-ui/db/x-ui.db /root/migration_backup/x-ui.db.bak

# 3. Бэкап текущих правил UFW
ufw status numbered > /root/migration_backup/ufw_rules.bak

echo "Резервные копии созданы в /root/migration_backup/"
```

---

## 3. Пошаговый план миграции

### Этап 1: Подготовка и установка Certbot

На этом этапе мы установим все необходимые утилиты.

```bash
# Обновляем списки пакетов
apt-get update

# Устанавливаем Certbot и плагин для Apache
apt-get install -y certbot python3-certbot-apache
```

### Этап 2 (новый): Изменение порта X-ray (VLESS) через командную строку

Вместо использования веб-интерфейса мы изменим порт X-ray напрямую в базе данных `3x-ui`. Панель хранит все свои настройки в файле SQLite, что позволяет нам вносить изменения с помощью командной строки.

1.  **Обновите базу данных `3x-ui`**
    Выполните следующую команду, чтобы в таблице `inbounds` изменить порт с `443` на `43443`.

    ```bash
    sqlite3 /root/3x-ui/db/x-ui.db "UPDATE inbounds SET port = 43443 WHERE port = 443;"
    ```

2.  **Перезапустите контейнер `3x-ui`**
    Это необходимо, чтобы панель управления перечитала настройки из базы данных и сгенерировала новый `config.json` для X-ray, применив изменение порта.

    ```bash
    docker restart 3x-ui
    ```

3.  **Проверьте статус контейнера**
    Убедитесь, что контейнер успешно перезапустился. Просмотрите логи, чтобы подтвердить, что X-ray запустился без ошибок на новом порту.

    ```bash
    docker logs 3x-ui
    ```
    *В логах не должно быть ошибок, и вы можете увидеть сообщения о том, что X-ray теперь прослушивает порт `43443`.*

### Этап 3: Настройка Брандмауэра (UFW)

Теперь откроем новый порт для X-ray. **Мы пока не закрываем старый порт 8443**, чтобы не потерять доступ к панели в процессе настройки.

```bash
# Разрешаем входящий трафик на новый порт для VLESS
ufw allow 43443/tcp comment 'X-ray VLESS new port'

# Проверяем, что правило добавилось
ufw status
```

### Этап 4: Конфигурация Apache2 и получение SSL-сертификата

Это самый важный этап. Мы перенастроим Apache на порт 443 и получим для него официальный сертификат.

1.  **Остановите Apache**, чтобы освободить порт 80 для проверки Certbot (если он его использует) и избежать конфликтов.
    ```bash
    systemctl stop apache2
    ```

2.  **Отредактируйте файл конфигурации Apache.**
    Нужно заменить все вхождения порта `8443` на `443`.
    ```bash
    sed -i 's/8443/443/g' /etc/apache2/sites-enabled/pgserver.online.conf
    ```
    Также нужно убрать указание порта из HTTP->HTTPS редиректа.
    ```bash
    sed -i 's|https://%{HTTP_HOST}:443%{REQUEST_URI}|https://%{HTTP_HOST}%{REQUEST_URI}|g' /etc/apache2/sites-enabled/pgserver.online.conf
    ```

3.  **Запустите Certbot для получения сертификата.**
    Certbot автоматически найдет ваш домен в конфигурации Apache, получит сертификат и сам изменит конфигурационный файл, прописав пути к новым сертификатам.
    ```bash
    # Замените you@example.com на ваш email
    certbot --apache -d pgserver.online --redirect --agree-tos -m you@example.com --no-eff-email
    ```
    *   `--apache`: использовать плагин Apache.
    *   `-d pgserver.online`: для какого домена выпустить сертификат.
    *   `--redirect`: автоматически настроить редирект с HTTP на HTTPS.
    *   `--agree-tos`: согласиться с условиями использования.
    *   `-m you@example.com`: ваш email для уведомлений.

4.  **Перезапустите Apache** для применения всех изменений.
    ```bash
    systemctl start apache2
    systemctl status apache2
    ```

### Этап 5: Проверка и завершение

1.  **Проверьте доступ к панели управления.** Откройте в браузере новый адрес: `https://pgserver.online/xray/` (без порта). Вы должны увидеть страницу входа, и браузер должен показать, что используется валидный сертификат (зеленый замок).
2.  **Проверьте подключение клиента X-ray.** Обновите конфигурацию в вашем клиентском приложени��, указав новый порт `43443`. Убедитесь, что подключение работает.
3.  **Проверьте автоматическое обновление сертификатов.**
    ```bash
    certbot renew --dry-run
    ```
    Команда должна завершиться успешно.

4.  **Закройте старый порт в UFW.** После того как вы убедились, что все работает, можно закрывать старый порт.
    ```bash
    # Находим номер правила для порта 8443
    ufw status numbered

    # Удаляем правило по его номеру (замените 'X' на нужный номер)
    # Пример: ufw delete 5
    ufw delete X

    echo "Миграция завершена!"
    ```

---

## 4. План отката (в случае неудачи)

Если что-то пошло не так, выполните следующие шаги для возврата к исходному состоянию:

1.  **Восстановите конфигурацию Apache:**
    ```bash
    cp /root/migration_backup/pgserver.online.conf.bak /etc/apache2/sites-enabled/pgserver.online.conf
    systemctl restart apache2
    ```

2.  **Восстановите базу данных 3x-ui:**
    Это вернет порт X-ray на `443`.
    ```bash
    # Останавливаем контейнер, чтобы безопасно заменить файл
    docker stop 3x-ui

    # Копируем бэкап базы
    cp /root/migration_backup/x-ui.db.bak /root/3x-ui/db/x-ui.db

    # Запускаем контейнер
    docker start 3x-ui
    ```

3.  **Настройте UFW:**
    *   Закройте порт `43443`: `ufw delete allow 43443/tcp`
    *   Убедитесь, что порт `8443` снова открыт (если вы его закрывали): `ufw allow 8443/tcp`

После выполнения этих шагов система вернется в состояние, в котором она была до начала миграции.
